{% extends "base.html" %}

{% block title %}General Settings - HuduGlue{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">General Settings</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Settings</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'core:settings_general' %}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-sliders-h"></i> General
                </a>
                <a href="{% url 'core:settings_security' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-shield-alt"></i> Security
                </a>
                <a href="{% url 'core:settings_smtp' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-envelope"></i> SMTP/Email
                </a>
                <a href="{% url 'core:settings_scheduler' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-clock"></i> Task Scheduler
                </a>
                <a href="{% url 'core:settings_directory' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-users-cog"></i> Directory Services
                </a>
                <a href="{% url 'core:settings_ai' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-robot"></i> AI & LLM
                </a>
                <a href="{% url 'core:settings_snyk' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-bug"></i> Snyk Security
                </a>
                <a href="{% url 'core:settings_kb_import' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-book-medical"></i> KB Article Import
                </a>
                <a href="{% url 'core:settings_data_export' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-file-export"></i> Data Export
                </a>
                <a href="{% url 'core:system_status' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-heartbeat"></i> System Status
                </a>
                <a href="{% url 'core:system_updates' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-sync-alt"></i> System Updates
                </a>
                <a href="{% url 'core:maintenance' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-tools"></i> Maintenance
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sliders-h"></i> General Settings</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="site_name" class="form-label">Site Name</label>
                        <input type="text" class="form-control" id="site_name" name="site_name" value="{{ settings.site_name }}" required>
                        <div class="form-text">The name of your installation (shown in header and emails)</div>
                    </div>

                    <div class="mb-3">
                        <label for="site_url" class="form-label">Site URL</label>
                        <input type="url" class="form-control" id="site_url" name="site_url" value="{{ settings.site_url }}" placeholder="https://yourdomain.com">
                        <div class="form-text">Base URL for email links and API callbacks</div>
                    </div>

                    <div class="mb-3">
                        <label for="default_timezone" class="form-label">Default Timezone</label>
                        <select class="form-select" id="default_timezone" name="default_timezone" required>
                            {% for tz_value, tz_label in timezone_choices %}
                            <option value="{{ tz_value }}" {% if settings.default_timezone == tz_value %}selected{% endif %}>{{ tz_label }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Default timezone for new users</div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            {% if settings.updated_at %}
                            Last updated: {{ settings.updated_at }}
                            {% if settings.updated_by %}
                            by {{ settings.updated_by.username }}
                            {% endif %}
                            {% endif %}
                        </small>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Demo Data Import -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-database"></i> Demo Data Import</h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    Import complete demo data for "Acme Corporation" including documents, diagrams, assets, passwords, KB articles, and processes.
                    This is useful for testing and demonstration purposes.
                </p>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>What will be imported:</strong>
                    <ul class="mb-0 mt-2">
                        <li>IT Procedures, Security Policies, and Runbooks</li>
                        <li>Network and Rack Diagrams</li>
                        <li>Workstations, Servers, and Network Equipment</li>
                        <li>Sample Passwords (demo credentials)</li>
                        <li>Knowledge Base Articles</li>
                        <li>IT Processes with execution history</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <label for="demo_organization" class="form-label">Select Organization *</label>
                    <select class="form-select" id="demo_organization" required>
                        <option value="">-- Select Organization --</option>
                        {% for org in user.organization_memberships.all %}
                        <option value="{{ org.organization.id }}">{{ org.organization.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Demo data will be imported into this organization</div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong>
                    This will add demo data to the selected organization. Make sure you select the correct organization.
                </div>

                <div id="importDemoResults" style="display: none;"></div>

                <button type="button" class="btn btn-primary" id="importDemoBtn">
                    <i class="fas fa-download"></i> Import Demo Data
                </button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $('#importDemoBtn').on('click', function() {
        const btn = $(this);
        const organizationId = $('#demo_organization').val();
        const resultsDiv = $('#importDemoResults');

        if (!organizationId) {
            alert('Please select an organization');
            return;
        }

        if (!confirm('Are you sure you want to import demo data? This will add multiple items to the selected organization.')) {
            return;
        }

        // Disable button
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin"></i> Importing...');
        resultsDiv.hide();

        // Send AJAX request
        $.ajax({
            url: '{% url "core:import_demo_data" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                organization_id: organizationId
            },
            success: function(response) {
                if (response.success) {
                    resultsDiv.html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>Success!</strong>
                            <p class="mb-0">${response.message}</p>
                        </div>
                    `);
                } else {
                    resultsDiv.html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${response.message}
                        </div>
                    `);
                }
                resultsDiv.show();

                // Re-enable button
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-download"></i> Import Demo Data');
            },
            error: function(xhr, status, error) {
                resultsDiv.html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${error}
                    </div>
                `).show();

                // Re-enable button
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-download"></i> Import Demo Data');
            }
        });
    });
});
</script>

{% endblock %}
