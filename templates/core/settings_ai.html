{% extends "base.html" %}

{% block title %}AI & LLM Settings - Client St0r{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">AI & LLM Settings</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-3">
        {% include "core/_settings_menu.html" with active_page="ai" %}
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot"></i> AI & LLM Settings</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Multi-LLM Provider Support:</strong> Client St0r now supports multiple LLM providers for AI documentation generation! Choose from Anthropic Claude, Moonshot AI (Kimi), MiniMax, or OpenAI. Each provider offers different capabilities, pricing, and language support.
                </div>

                <form method="post">
                    {% csrf_token %}

                    <!-- LLM Provider Selection -->
                    <h5 class="mb-3"><i class="fas fa-network-wired"></i> LLM Provider Selection</h5>

                    <div class="mb-4">
                        <label for="llm_provider" class="form-label fw-bold">Active LLM Provider</label>
                        <select class="form-select form-select-lg" id="llm_provider" name="llm_provider" onchange="toggleProviderSections()">
                            <option value="anthropic" {% if current_llm_provider == 'anthropic' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ Anthropic Claude (English, Multilingual)</option>
                            <option value="moonshot" {% if current_llm_provider == 'moonshot' %}selected{% endif %}>ðŸ‡¨ðŸ‡³ Moonshot AI - Kimi (Chinese, English)</option>
                            <option value="minimax" {% if current_llm_provider == 'minimax' %}selected{% endif %}>ðŸ‡¨ðŸ‡³ MiniMax Chat API (Chinese, English)</option>
                            <option value="minimax_coding" {% if current_llm_provider == 'minimax_coding' %}selected{% endif %}>ðŸ‡¨ðŸ‡³ MiniMax Coding Plan M2.5 (Code Generation)</option>
                            <option value="openai" {% if current_llm_provider == 'openai' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ OpenAI GPT (English, Multilingual)</option>
                        </select>
                        <div class="form-text">
                            Select which LLM provider to use for AI documentation generation, floor plans, and content enhancement.
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Anthropic Claude Section -->
                    <div id="anthropic-section" class="provider-section">
                        <h5 class="mb-3"><i class="fas fa-robot"></i> Anthropic Claude</h5>

                    <div class="mb-3">
                        <label for="anthropic_api_key" class="form-label">Anthropic API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="anthropic_api_key" name="anthropic_api_key" value="{{ current_anthropic_key }}" placeholder="sk-ant-api03-...">
                            <button type="button" class="btn btn-outline-secondary" id="test-anthropic-btn" onclick="testAnthropicKey()">
                                <i class="fas fa-vial"></i> Test
                            </button>
                        </div>
                        <div id="anthropic-test-result" class="mt-2" style="display: none;"></div>
                        <div class="form-text">
                            Required for AI floor plan generation and documentation. Get your API key at <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="claude_model" class="form-label">Claude Model</label>
                        <select class="form-select" id="claude_model" name="claude_model">
                            <option value="claude-opus-4-5-20251101" {% if current_claude_model == 'claude-opus-4-5-20251101' %}selected{% endif %}>Claude Opus 4.5 (Most Capable)</option>
                            <option value="claude-sonnet-4-5-20250929" {% if current_claude_model == 'claude-sonnet-4-5-20250929' %}selected{% endif %}>Claude Sonnet 4.5 (Balanced - Recommended)</option>
                            <option value="claude-3-5-sonnet-20241022" {% if current_claude_model == 'claude-3-5-sonnet-20241022' %}selected{% endif %}>Claude 3.5 Sonnet (Legacy)</option>
                            <option value="claude-3-5-haiku-20241022" {% if current_claude_model == 'claude-3-5-haiku-20241022' %}selected{% endif %}>Claude 3.5 Haiku (Fastest, Lower Cost)</option>
                        </select>
                        <div class="form-text">
                            Choose the Claude model for AI generation. Sonnet 4.5 offers the best balance of quality and cost.
                        </div>
                    </div>
                    </div>

                    <!-- Moonshot AI (Kimi) Section -->
                    <div id="moonshot-section" class="provider-section" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-moon"></i> Moonshot AI (Kimi)</h5>

                        <div class="mb-3">
                            <label for="moonshot_api_key" class="form-label">Moonshot API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="moonshot_api_key" name="moonshot_api_key" value="{{ current_moonshot_key }}" placeholder="sk-...">
                                <button type="button" class="btn btn-outline-secondary" id="test-moonshot-btn" onclick="testMoonshotKey()">
                                    <i class="fas fa-vial"></i> Test
                                </button>
                            </div>
                            <div id="moonshot-test-result" class="mt-2" style="display: none;"></div>
                            <div class="form-text">
                                Get your API key at <a href="https://platform.moonshot.cn/" target="_blank">platform.moonshot.cn</a>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="moonshot_model" class="form-label">Kimi Model</label>
                            <select class="form-select" id="moonshot_model" name="moonshot_model">
                                <option value="moonshot-v1-8k" {% if current_moonshot_model == 'moonshot-v1-8k' %}selected{% endif %}>Kimi v1 8K (Standard)</option>
                                <option value="moonshot-v1-32k" {% if current_moonshot_model == 'moonshot-v1-32k' %}selected{% endif %}>Kimi v1 32K (Extended Context)</option>
                                <option value="moonshot-v1-128k" {% if current_moonshot_model == 'moonshot-v1-128k' %}selected{% endif %}>Kimi v1 128K (Maximum Context)</option>
                            </select>
                            <div class="form-text">
                                Excellent for Chinese language documentation. Supports both Chinese and English.
                            </div>
                        </div>
                    </div>

                    <!-- MiniMax Section -->
                    <div id="minimax-section" class="provider-section" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-dragon"></i> MiniMax</h5>

                        <div class="mb-3">
                            <label for="minimax_api_key" class="form-label">MiniMax API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="minimax_api_key" name="minimax_api_key" value="{{ current_minimax_key }}" placeholder="...">
                                <button type="button" class="btn btn-outline-secondary" id="test-minimax-btn" onclick="testMinimaxKey()">
                                    <i class="fas fa-vial"></i> Test
                                </button>
                            </div>
                            <div id="minimax-test-result" class="mt-2" style="display: none;"></div>
                            <div class="form-text">
                                Get your API key at <a href="https://api.minimax.chat/" target="_blank">api.minimax.chat</a> or <a href="https://platform.minimax.io/" target="_blank">platform.minimax.io</a>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="minimax_group_id" class="form-label">MiniMax Group ID</label>
                            <input type="text" class="form-control font-monospace" id="minimax_group_id" name="minimax_group_id" value="{{ current_minimax_group_id }}" placeholder="Group ID from MiniMax console">
                            <div class="form-text">
                                Required for MiniMax API. Find this in your MiniMax console dashboard.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="minimax_model" class="form-label">MiniMax Model</label>
                            <select class="form-select" id="minimax_model" name="minimax_model">
                                <option value="abab6.5-chat" {% if current_minimax_model == 'abab6.5-chat' %}selected{% endif %}>abab6.5-chat (Latest)</option>
                                <option value="abab6.5s-chat" {% if current_minimax_model == 'abab6.5s-chat' %}selected{% endif %}>abab6.5s-chat (Speed Optimized)</option>
                                <option value="abab5.5-chat" {% if current_minimax_model == 'abab5.5-chat' %}selected{% endif %}>abab5.5-chat (Legacy)</option>
                            </select>
                            <div class="form-text">
                                Strong Chinese language support with competitive pricing.
                            </div>
                        </div>
                    </div>

                    <!-- MiniMax Coding Plan Section -->
                    <div id="minimax_coding-section" class="provider-section" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-code"></i> MiniMax Coding Plan (M2.5)</h5>

                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> This is for the MiniMax Coding Plan API from platform.minimax.io, which is different from the Chat API. If you have a Coding Plan subscription with M2.5 model, use this option.
                        </div>

                        <div class="mb-3">
                            <label for="minimax_coding_api_key" class="form-label">MiniMax Coding API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="minimax_coding_api_key" name="minimax_coding_api_key" value="{{ current_minimax_coding_key }}" placeholder="Your Coding Plan API key">
                                <button type="button" class="btn btn-outline-secondary" id="test-minimax-coding-btn" onclick="testMinimaxCodingKey()">
                                    <i class="fas fa-vial"></i> Test
                                </button>
                            </div>
                            <div id="minimax-coding-test-result" class="mt-2" style="display: none;"></div>
                            <div class="form-text">
                                Get your Coding Plan API key at <a href="https://platform.minimax.io/user-center/basic-information/interface-key" target="_blank">platform.minimax.io</a>. This key is different from the Chat API key.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="minimax_coding_model" class="form-label">Model</label>
                            <select class="form-select" id="minimax_coding_model" name="minimax_coding_model">
                                <option value="MiniMax-M2.5" {% if current_minimax_coding_model == 'MiniMax-M2.5' %}selected{% endif %}>MiniMax-M2.5 (Coding Optimized)</option>
                            </select>
                            <div class="form-text">
                                M2.5 model optimized for code generation and documentation.
                            </div>
                        </div>
                    </div>

                    <!-- OpenAI Section -->
                    <div id="openai-section" class="provider-section" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-brain"></i> OpenAI GPT</h5>

                        <div class="mb-3">
                            <label for="openai_api_key" class="form-label">OpenAI API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="openai_api_key" name="openai_api_key" value="{{ current_openai_key }}" placeholder="sk-...">
                                <button type="button" class="btn btn-outline-secondary" id="test-openai-btn" onclick="testOpenAIKey()">
                                    <i class="fas fa-vial"></i> Test
                                </button>
                            </div>
                            <div id="openai-test-result" class="mt-2" style="display: none;"></div>
                            <div class="form-text">
                                Get your API key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="openai_model" class="form-label">OpenAI Model</label>
                            <select class="form-select" id="openai_model" name="openai_model">
                                <option value="gpt-4o" {% if current_openai_model == 'gpt-4o' %}selected{% endif %}>GPT-4o (Latest, Multimodal)</option>
                                <option value="gpt-4-turbo" {% if current_openai_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo (Fast)</option>
                                <option value="gpt-3.5-turbo" {% if current_openai_model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo (Budget)</option>
                            </select>
                            <div class="form-text">
                                Industry-standard models with excellent multilingual support.
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3"><i class="fas fa-map"></i> Mapping & Geocoding (Optional)</h5>

                    <div class="mb-3">
                        <label for="google_maps_api_key" class="form-label">Google Maps API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="google_maps_api_key" name="google_maps_api_key" value="{{ current_google_maps_key }}" placeholder="AIza...">
                            <button type="button" class="btn btn-outline-secondary" id="test-googlemaps-btn" onclick="testGoogleMapsKey()">
                                <i class="fas fa-vial"></i> Test
                            </button>
                        </div>
                        <div id="googlemaps-test-result" class="mt-2" style="display: none;"></div>
                        <div class="form-text">
                            Optional. Used for geocoding addresses and fetching satellite imagery.
                        </div>
                    </div>

                    <div class="alert alert-info border-warning">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <strong>Important: Google Maps Setup Instructions</strong>
                        <p class="mb-2 mt-2">You need <strong>ONE API key</strong> but must enable <strong>4 different APIs</strong> in your Google Cloud project:</p>
                        <ol class="mb-2 small">
                            <li><strong>Create/Select Project:</strong> Go to <a href="https://console.cloud.google.com/" target="_blank" class="alert-link">Google Cloud Console</a> and select or create a project</li>
                            <li><strong>Enable these 4 APIs</strong> (go to <a href="https://console.cloud.google.com/apis/library" target="_blank" class="alert-link">API Library</a>, search for each, and click "Enable"):
                                <ul class="mt-1">
                                    <li><strong>Maps Embed API</strong> - For interactive maps</li>
                                    <li><strong>Maps Static API</strong> - For satellite imagery</li>
                                    <li><strong>Geocoding API</strong> - For address to coordinates conversion</li>
                                    <li><strong>Places API (New)</strong> - For property data lookup</li>
                                </ul>
                            </li>
                            <li><strong>Create ONE API Key:</strong> <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="alert-link">Credentials</a> â†’ "Create Credentials" â†’ "API Key"</li>
                            <li><strong>Copy the single API key</strong> and paste it above. This one key works for all enabled APIs.</li>
                        </ol>
                        <p class="mb-1 small"><strong>Important:</strong> You don't need separate keys for each API - just ONE key with all APIs enabled!</p>
                        <p class="mb-0 small"><strong>Billing:</strong> Each API has a generous free tier. Google requires a billing account but won't charge unless you exceed free limits (unlikely for typical usage).</p>
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3">Property Data APIs (Optional)</h5>

                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Free Option Available!</strong> Client St0r now automatically tries municipal tax collector records (public property data) when you click "Auto-Refresh" on location pages.
                        <strong>No configuration needed</strong> - works for Florida counties and many other US jurisdictions.
                    </div>

                    <div class="alert alert-info border-warning">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <strong>Premium Services (Below):</strong> These paid APIs provide comprehensive building information beyond what's available in public records.
                        <strong>Not required</strong> - you can use free municipal data or manually enter building information.
                    </div>

                    <div class="mb-3">
                        <label for="regrid_api_key" class="form-label">Regrid API Key</label>
                        <input type="password" class="form-control font-monospace" id="regrid_api_key" name="regrid_api_key" value="{{ current_regrid_key }}" placeholder="Leave blank if not using">
                        <div class="form-text">
                            Optional. Provides property/parcel data. <a href="https://regrid.com/pricing" target="_blank">Starting at $299/month</a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="attom_api_key" class="form-label">AttomData API Key</label>
                        <input type="password" class="form-control font-monospace" id="attom_api_key" name="attom_api_key" value="{{ current_attom_key }}" placeholder="Leave blank if not using">
                        <div class="form-text">
                            Optional. Provides property details and valuations. <a href="https://www.attomdata.com/solutions/" target="_blank">Contact for pricing</a>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Automatic Restart:</strong> When you save settings, the application will automatically restart to apply the new API keys. This takes about 2-3 seconds.
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Changes are saved to .env file
                        </small>
                        <button type="submit" class="btn btn-primary" id="saveSettingsBtn">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </form>

                <hr class="my-4">

                <h5 class="mb-3">Usage Information</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Required API</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>AI Floor Plan Generation</td>
                                <td>Anthropic Claude</td>
                                <td>
                                    {% if current_anthropic_key %}
                                    <span class="badge bg-success">Configured</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">Not Configured</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Address Geocoding</td>
                                <td>Google Maps</td>
                                <td>
                                    {% if current_google_maps_key %}
                                    <span class="badge bg-success">Configured</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Optional</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Satellite Imagery</td>
                                <td>Google Maps</td>
                                <td>
                                    {% if current_google_maps_key %}
                                    <span class="badge bg-success">Configured</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Optional</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card bg-light mt-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-lightbulb"></i> Cost Estimates</h6>
                        <p class="card-text small mb-2">
                            <strong>Claude Sonnet 4.5:</strong> ~$0.03-0.10 per floor plan<br>
                            <strong>Claude Opus 4.5:</strong> ~$0.15-0.30 per floor plan<br>
                            <strong>Claude Haiku 3.5:</strong> ~$0.01-0.03 per floor plan
                        </p>
                        <p class="card-text small text-muted mb-0">
                            Actual costs depend on building complexity and requirements. Most office floor plans use 500-2000 tokens.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restart Loading Overlay -->
<div id="restartOverlay" class="restart-overlay" style="display: none;">
    <div class="restart-modal">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="text-primary mb-2">Now restarting services...</h4>
        <p class="text-muted mb-0">Applying your API key changes</p>
        <div class="progress mt-3" style="height: 4px; width: 250px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
        </div>
    </div>
</div>

<style>
.restart-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-in-out;
}

.restart-modal {
    background: white;
    padding: 40px 60px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.4s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Dark theme support */
[data-bs-theme="dark"] .restart-modal {
    background: #2d3748;
    color: #e2e8f0;
}

[data-bs-theme="dark"] .restart-modal h4 {
    color: #90cdf4 !important;
}

[data-bs-theme="dark"] .restart-modal .text-muted {
    color: #a0aec0 !important;
}
</style>

<script>
// Toggle provider sections based on selection
function toggleProviderSections() {
    const provider = document.getElementById('llm_provider').value;
    const sections = ['anthropic', 'moonshot', 'minimax', 'minimax_coding', 'openai'];

    sections.forEach(section => {
        const element = document.getElementById(section + '-section');
        if (element) {
            element.style.display = (section === provider) ? 'block' : 'none';
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleProviderSections();
});

// API Key Testing Functions
function testAnthropicKey() {
    const apiKey = document.getElementById('anthropic_api_key').value;
    const btn = document.getElementById('test-anthropic-btn');
    const resultDiv = document.getElementById('anthropic-test-result');

    if (!apiKey) {
        resultDiv.innerHTML = '<div class="alert alert-warning small mb-0"><i class="fas fa-exclamation-circle"></i> Please enter an API key first</div>';
        resultDiv.style.display = 'block';
        return;
    }

    // Show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    resultDiv.innerHTML = '<div class="alert alert-info small mb-0"><i class="fas fa-spinner fa-spin"></i> Testing API key...</div>';
    resultDiv.style.display = 'block';

    // Call validation endpoint
    fetch('{% url "core:validate_anthropic_key" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ api_key: apiKey })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success small mb-0"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> ${data.message}</div>`;
        }
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';
        resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
        resultDiv.style.display = 'block';
    });
}

function testGoogleMapsKey() {
    const apiKey = document.getElementById('google_maps_api_key').value;
    const btn = document.getElementById('test-googlemaps-btn');
    const resultDiv = document.getElementById('googlemaps-test-result');

    if (!apiKey) {
        resultDiv.innerHTML = '<div class="alert alert-warning small mb-0"><i class="fas fa-exclamation-circle"></i> Please enter an API key first</div>';
        resultDiv.style.display = 'block';
        return;
    }

    // Show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    resultDiv.innerHTML = '<div class="alert alert-info small mb-0"><i class="fas fa-spinner fa-spin"></i> Testing API key...</div>';
    resultDiv.style.display = 'block';

    // Call validation endpoint
    fetch('{% url "core:validate_google_maps_key" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ api_key: apiKey })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success small mb-0"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> ${data.message}</div>`;
        }
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';
        resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
        resultDiv.style.display = 'block';
    });
}

function testMoonshotKey() {
    const apiKey = document.getElementById('moonshot_api_key').value;
    const model = document.getElementById('moonshot_model').value;
    const btn = document.getElementById('test-moonshot-btn');
    const resultDiv = document.getElementById('moonshot-test-result');

    if (!apiKey) {
        resultDiv.innerHTML = '<div class="alert alert-warning small mb-0"><i class="fas fa-exclamation-circle"></i> Please enter an API key first</div>';
        resultDiv.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    resultDiv.innerHTML = '<div class="alert alert-info small mb-0"><i class="fas fa-spinner fa-spin"></i> Testing Moonshot connection...</div>';
    resultDiv.style.display = 'block';

    fetch('{% url "core:test_llm_connection" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ provider: 'moonshot', api_key: apiKey, model: model })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success small mb-0"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> ${data.error}</div>`;
        }
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';
        resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
        resultDiv.style.display = 'block';
    });
}

function testMinimaxKey() {
    const apiKey = document.getElementById('minimax_api_key').value;
    const groupId = document.getElementById('minimax_group_id').value;
    const model = document.getElementById('minimax_model').value;
    const btn = document.getElementById('test-minimax-btn');
    const resultDiv = document.getElementById('minimax-test-result');

    if (!apiKey || !groupId) {
        resultDiv.innerHTML = '<div class="alert alert-warning small mb-0"><i class="fas fa-exclamation-circle"></i> Please enter both API key and Group ID</div>';
        resultDiv.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    resultDiv.innerHTML = '<div class="alert alert-info small mb-0"><i class="fas fa-spinner fa-spin"></i> Testing MiniMax connection...</div>';
    resultDiv.style.display = 'block';

    fetch('{% url "core:test_llm_connection" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ provider: 'minimax', api_key: apiKey, group_id: groupId, model: model })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success small mb-0"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> ${data.error}</div>`;
        }
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';
        resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
        resultDiv.style.display = 'block';
    });
}

function testOpenAIKey() {
    const apiKey = document.getElementById('openai_api_key').value;
    const model = document.getElementById('openai_model').value;
    const btn = document.getElementById('test-openai-btn');
    const resultDiv = document.getElementById('openai-test-result');

    if (!apiKey) {
        resultDiv.innerHTML = '<div class="alert alert-warning small mb-0"><i class="fas fa-exclamation-circle"></i> Please enter an API key first</div>';
        resultDiv.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    resultDiv.innerHTML = '<div class="alert alert-info small mb-0"><i class="fas fa-spinner fa-spin"></i> Testing OpenAI connection...</div>';
    resultDiv.style.display = 'block';

    fetch('{% url "core:test_llm_connection" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ provider: 'openai', api_key: apiKey, model: model })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success small mb-0"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> ${data.error}</div>`;
        }
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';
        resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
        resultDiv.style.display = 'block';
    });
}

function testMinimaxCodingKey() {
    const apiKey = document.getElementById('minimax_coding_api_key').value;
    const model = document.getElementById('minimax_coding_model').value;
    const btn = document.getElementById('test-minimax-coding-btn');
    const resultDiv = document.getElementById('minimax-coding-test-result');

    if (!apiKey) {
        resultDiv.innerHTML = '<div class="alert alert-warning small mb-0"><i class="fas fa-exclamation-circle"></i> Please enter an API key first</div>';
        resultDiv.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    resultDiv.innerHTML = '<div class="alert alert-info small mb-0"><i class="fas fa-spinner fa-spin"></i> Testing MiniMax Coding connection...</div>';
    resultDiv.style.display = 'block';

    fetch('{% url "core:test_llm_connection" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ provider: 'minimax_coding', api_key: apiKey, model: model })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success small mb-0"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> ${data.error}</div>`;
        }
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-vial"></i> Test';
        resultDiv.innerHTML = `<div class="alert alert-danger small mb-0"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
        resultDiv.style.display = 'block';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const overlay = document.getElementById('restartOverlay');
    const saveBtn = document.getElementById('saveSettingsBtn');

    form.addEventListener('submit', function(e) {
        // Show the restart overlay
        overlay.style.display = 'flex';

        // Disable the save button to prevent double submission
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        // The form will submit normally, and the page will reload after restart
        // If the reload takes longer than expected, show a message
        setTimeout(function() {
            if (overlay.style.display !== 'none') {
                // Still waiting after 10 seconds - add a message
                const modal = document.querySelector('.restart-modal p');
                modal.innerHTML = 'Taking longer than expected. Please wait...<br><small>If this continues, refresh the page manually.</small>';
            }
        }, 10000);
    });
});
</script>

{% endblock %}
